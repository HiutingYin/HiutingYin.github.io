---
title: 根据腾讯视频单条视频地址获取对应基础信息
author: HiuTingYin
date: 2021-08-30 18:53:00 +0800

categories: 
- 日常问题合集
tags: 
- PHP
excerpt：投稿活动开发过程中有个需求，需要玩家输入对应的腾讯视频链接后，需要读取该视频的标题、封面、播放地址等信息。
---


### 问题描述

投稿活动开发过程中有个需求，需要玩家输入对应的腾讯视频链接后，需要读取该视频的标题、封面、播放地址等信息。

### 解决方法
通过对腾讯视频页面的源代码解析，获取所需信息。
1、通过curl抓取页面
2、解析抓取结果以此判断地址的合理性

```php
    $url = 'https://v.qq.com/x/page/m0558ormcfk.html';
    $url = str_replace('http:', 'https:', $url);
    $parsedUrl = parse_url($url);
    $host = $parsedUrl['host'];
    if (!in_array($host, ['v.qq.com', 'm.v.qq.com'])) {
        return false;
    }
    $matches = [];
    $fixedUrl = '';
    //获取视频vid
    if ($host == 'v.qq.com') {
        if (!preg_match('@/x/page/(.+).html@', $parsedUrl['path'], $matches) && !preg_match('@/x/cover/(.+).html@', $parsedUrl['path'], $matches)) {
        return false;
        }
        $vid = $matches[1];
        if (preg_match('@/x/page/(.+).html@', $parsedUrl['path'], $matches)) {
        $fixedUrl = 'https://v.qq.com/x/page/' . $vid . '.html';
        } elseif (preg_match('@/x/cover/(.+).html@', $parsedUrl['path'], $matches)) {
        $fixedUrl = 'https://v.qq.com/x/cover/' . $vid . '.html';
        $vids = explode('/', $vid);
        if (count($vids) == 2) {
            $vid = $vids[1];
        }
        }
    } else {
        parse_str($parsedUrl['query'], $matches);
        $vid = $matches['vid'];
        if (!$vid) {
        return false;
        }
        $fixedUrl = 'https://v.qq.com/x/page/' . $vid . '.html';
    }
    if (!$fixedUrl) {
        return false;
    }
    $rv = [
        'vid'       => $vid,
        'url'       => $url,
        'iframeurl' => 'https://v.qq.com/txp/iframe/player.html?vid=' . $vid,//iframe视频播放地址
    ];
    //抓取页面返回结果
    $html = Request::curl($fixedUrl);
    preg_match("#class=\"page_404\"#imsu", $html, $isNotFind);
    if ($isNotFind) {
        return false;
    }
    //获取视频封面
    preg_match("/\"pic_640_360\":\".*?\"/is", $html, $pic);
    $pic = str_replace('"', '', str_replace('"pic_640_360":', '', $pic));
    //获取视频标题
    preg_match("/\"title\":\".*?\"/is", $html, $titleStr);
    $title = str_replace('"', '', str_replace('"title":', '', $titleStr));
    if ($title) {
        $rv['title'] = $title[0];
    }
    if ($pic) {
        $rv['cover'] = $pic[0];
    }
    echo "<pre>";
    var_dump($rv);
```

返回示例：
```php
array(5) {
  ["vid"]=>
  string(11) "m0558ormcfk"
  ["url"]=>
  string(40) "https://v.qq.com/x/page/m0558ormcfk.html"
  ["iframeurl"]=>
  string(55) "https://v.qq.com/txp/iframe/player.html?vid=m0558ormcfk"
  ["title"]=>
  string(60) "英魂之刃最强王者SOLO赛 林初心 VS 忘情第一局"
  ["cover"]=>
  string(44) "http://puui.qpic.cn/vpic/0/m0558ormcfk.png/0"
}
```
